//https://spreadsheets.google.com/feeds/cells/0AuFt9cSl5maddEtiOG9rNUstdW80dmlyakRFYnlPeXc/od6/public/values?alt=json&callback=od6

function JsonToArray(json) {
	var height = json.feed.gs$rowCount["$t"];
	var width = json.feed.gs$colCount["$t"];
	var array = new Array(height);
	for ( var r = 0; r < height; ++r) {
		array[r] = new Array(width);
	}
	var entries = json.feed.entry;
	for ( var i = 0; i < entries.length; ++i) {
		var entry = entries[i]["gs$cell"];
		var row = entry.row;
		var col = entry.col;
		var value = entry["$t"];
		array[row - 1][col - 1] = value;
	}// for
	return array;
}// JsonToArray


function RawData2() {
	// alert("before");
	var url = "http://python-0005-nhk.odenkiapi.appspot.com/RawData2?callback=?";
	// var url =
	// "https://spreadsheets.google.com/feeds/cells/0AuFt9cSl5maddEtiOG9rNUstdW80dmlyakRFYnlPeXc/1/public/values?alt=json&callback=?";
	// var url = "http://www.yahoo.com/";
	$.getJSON(url, {}, function(json) {
		drawMyGeneratorChart(json.timeVsWatt);
	});
	// alert("after");
	setTimeout(RawData2, 10000);
}// RawData2

function Sheet(sheet_id) {
	// 2x2 array is given to callback
	this.url = "https://spreadsheets.google.com/feeds/cells/0AuFt9cSl5maddEtiOG9rNUstdW80dmlyakRFYnlPeXc/"
			+ sheet_id + "/public/values?callback=?";

	this.array = null;

	this.fetch = function() {
		// this.callback.bind(this)();
		// this.callback.bind(this)();
		var self = this;
		$.getJSON(this.url, {
			alt : "json"
		}, function(json) {
			self.array = JsonToArray(json);
		});
	}// fetch

	this.getArray = function(callback) {
		// this is a blocking function, polling interval is 100ms
		var self = this;
		if (self.array != null) {
			// alert("in setTimeout, self.array = " + self.array);
			// alert("in setTimeout, self.getArray = " + self.getArray);
			// alert("in setTimeout, callback = " + callback)
			callback(self.array);
		} else {
			setTimeout(function() {
				// alert("in setTimeout, self.array = " + self.array);
				// alert("in setTimeout, self.getArray = " + self.getArray);
				// alert("in setTimeout, callback = " + callback)
				// alert(self.getArray.call);
				self.getArray(callback);
			}, 100);
		}// if
	}// getArray

	this.fetch();

}// Sheet

function drawTotalElectricityChart(div) {
	var od6 = new Sheet("od6");
	od6.getArray(function(array) {
		var totalElectricityGenerated = new google.visualization.DataTable();
		totalElectricityGenerated.addColumn("datetime", "発電日");
		totalElectricityGenerated.addColumn("number", "発電量(kWh)");
		for ( var i = 0; i < array.length; ++i) {
			var row = array[i];
			totalElectricityGenerated.addRow([
					new Date(row[0], row[1], row[2]), Number(row[3]) ]);
			// totalElectricityGenerated.addRow([new Date(1990,10,10), 100] );
		}// for
		var lineChart = new google.visualization.LineChart(div);
		lineChart.draw(totalElectricityGenerated, {
			title : 'みんなの発電量',
			height : 300,
			width : $(window).width() * 0.95
		});
	});
}// drawTotalElectricityChart

function drawmap(div) {
	var od7 = new Sheet("od7");
	od7
			.getArray(function(array) {
				var map = new google.maps.Map(div, {
					center : new google.maps.LatLng(Number(array[1][2]),
							Number(array[1][3])),
					zoom : 10,
					mapTypeId : 'terrain',
					height : 500,
					width : $(window).width() * 0.95
				});
				var marker_clusterer = new MarkerClusterer(map, null, {
					maxZoom : 19
				});
				marker_clusterer.addMarker(new google.maps.Marker({
					position : new google.maps.LatLng(33, 132),
					title : "松山"
				}));
				for ( var i = 2; i < array.length; ++i) {
					var row = array[i];
					var latlng = new google.maps.LatLng(Number(row[2]),
							Number(row[3]));
					var title = row[0];
					var marker = new google.maps.Marker({
						position : latlng,
						title : title
					});
					marker_clusterer.addMarker(marker);
				}
				marker_clusterer.redraw();

			});
}// drawmap

function drawRanking(div) {
	var sheet = new Sheet("3");
	sheet.getArray(function(array) {
		var data_table = new google.visualization.DataTable();
		data_table.addColumn("number", "順位");
		data_table.addColumn("string", "グループ");
		data_table.addColumn("number", "発電量");
		data_table.addColumn("string", "コメント");
		data_table.addColumn("number", "規模");
		for ( var i = 1; i < array.length; ++i) {
			var row = array[i];
			data_table.addRow([ Number(row[0]), row[1], Number(row[4]), row[5],
					Number(row[3]) ]);
			data_table.setFormattedValue(i - 1, 1, '<img src="' + row[6]
					+ '" width="40px" height="40px"></img>' + row[1]);
		}// for
		var table = new google.visualization.Table(div);
		table.draw(data_table, {
			allowHtml : true
		});
	});
}// drawRanking

function showMyGeneratorNow(year, month, day, hour, minute, watt) {
	$("#myGeneratorYear").text(year + "年");
	$("#myGeneratorMonth").text(month + "月");
	$("#myGeneratorDay").text(day + "日");
	$("#myGeneratorHour").text(hour + "時");
	$("#myGeneratorMinute").text(minute + "分");
	$("#myGeneratorWatt").text(watt + "ワット");
}// showMyGeneratorNow

function drawMyGeneratorChart(array) {
	var div = document.getElementById("myGeneratorChart");
	var data_table = new google.visualization.DataTable();
	data_table.addColumn("datetime", "発電日時");
	data_table.addColumn("number", "発電量(W)");
	showMyGeneratorNow(Number(array[0][1]), Number(array[0][2]),
			Number(array[0][3]), Number(array[0][4]), Number(array[0][5]),
			Number(array[0][0]).toFixed(0));
	for ( var i = 0; i < 450; ++i) {
		var row = array[i];
		data_table.addRow([
				new Date(Number(row[1]), Number(row[2]), Number(row[3]),
						Number(row[4]), Number(row[5])), Number(row[0]) ]);
		// totalElectricityGenerated.addRow([new Date(1990,10,10), 100] );
	}// for
	var areaChart = new google.visualization.AreaChart(div);
	areaChart.draw(data_table, {
		title : '発電量',
		height : 350,
		pointSize: 3,
		width : $(window).width() * 0.95
	});
}

dummygen = [ [ "692.028870", "2012", "08", "20", "08", "17", "09" ],
		[ "682.837891", "2012", "08", "20", "08", "16", "09" ],
		[ "1166.614014", "2012", "08", "20", "08", "15", "09" ],
		[ "1271.848145", "2012", "08", "20", "08", "14", "09" ],
		[ "1004.760254", "2012", "08", "20", "08", "13", "09" ],
		[ "836.486816", "2012", "08", "20", "08", "12", "09" ],
		[ "1061.152100", "2012", "08", "20", "08", "11", "09" ],
		[ "863.964294", "2012", "08", "20", "08", "10", "09" ],
		[ "1109.431274", "2012", "08", "20", "08", "09", "09" ],
		[ "1100.958008", "2012", "08", "20", "08", "08", "09" ],
		[ "1089.689697", "2012", "08", "20", "08", "07", "09" ],
		[ "1072.646484", "2012", "08", "20", "08", "06", "09" ],
		[ "1065.982178", "2012", "08", "20", "08", "05", "09" ],
		[ "1032.244263", "2012", "08", "20", "08", "04", "09" ],
		[ "1002.522888", "2012", "08", "20", "08", "03", "09" ],
		[ "993.079712", "2012", "08", "20", "08", "02", "09" ],
		[ "968.321960", "2012", "08", "20", "08", "01", "09" ],
		[ "934.220581", "2012", "08", "20", "08", "00", "09" ],
		[ "930.022766", "2012", "08", "20", "07", "59", "09" ],
		[ "921.120605", "2012", "08", "20", "07", "58", "09" ],
		[ "912.515503", "2012", "08", "20", "07", "57", "09" ],
		[ "910.473633", "2012", "08", "20", "07", "56", "09" ],
		[ "903.504395", "2012", "08", "20", "07", "55", "09" ],
		[ "896.743042", "2012", "08", "20", "07", "54", "09" ],
		[ "895.099731", "2012", "08", "20", "07", "53", "09" ],
		[ "908.802734", "2012", "08", "20", "07", "52", "09" ],
		[ "908.412170", "2012", "08", "20", "07", "51", "09" ],
		[ "890.087830", "2012", "08", "20", "07", "50", "09" ],
		[ "881.857666", "2012", "08", "20", "07", "49", "09" ],
		[ "455.770172", "2012", "08", "20", "07", "48", "09" ],
		[ "649.435181", "2012", "08", "20", "07", "47", "09" ],
		[ "660.844971", "2012", "08", "20", "07", "46", "09" ],
		[ "696.124634", "2012", "08", "20", "07", "45", "09" ],
		[ "831.182861", "2012", "08", "20", "07", "44", "09" ],
		[ "786.601563", "2012", "08", "20", "07", "43", "09" ],
		[ "815.554321", "2012", "08", "20", "07", "42", "09" ],
		[ "789.152039", "2012", "08", "20", "07", "41", "09" ],
		[ "776.956543", "2012", "08", "20", "07", "40", "09" ],
		[ "792.424683", "2012", "08", "20", "07", "39", "09" ],
		[ "662.133728", "2012", "08", "20", "07", "38", "09" ],
		[ "670.354858", "2012", "08", "20", "07", "37", "09" ],
		[ "549.764038", "2012", "08", "20", "07", "36", "09" ],
		[ "770.775391", "2012", "08", "20", "07", "35", "09" ],
		[ "759.338257", "2012", "08", "20", "07", "34", "09" ],
		[ "749.888428", "2012", "08", "20", "07", "33", "09" ],
		[ "742.802856", "2012", "08", "20", "07", "32", "09" ],
		[ "743.069092", "2012", "08", "20", "07", "31", "09" ],
		[ "740.759766", "2012", "08", "20", "07", "30", "09" ],
		[ "751.732056", "2012", "08", "20", "07", "29", "09" ],
		[ "759.978760", "2012", "08", "20", "07", "28", "09" ],
		[ "761.940552", "2012", "08", "20", "07", "27", "09" ],
		[ "713.098511", "2012", "08", "20", "07", "26", "09" ],
		[ "688.253418", "2012", "08", "20", "07", "25", "10" ],
		[ "651.335327", "2012", "08", "20", "07", "24", "09" ],
		[ "639.839661", "2012", "08", "20", "07", "23", "10" ],
		[ "615.087830", "2012", "08", "20", "07", "22", "10" ],
		[ "615.447998", "2012", "08", "20", "07", "21", "10" ],
		[ "585.743652", "2012", "08", "20", "07", "20", "09" ],
		[ "572.609619", "2012", "08", "20", "07", "19", "10" ],
		[ "467.049713", "2012", "08", "20", "07", "18", "10" ],
		[ "554.934204", "2012", "08", "20", "07", "17", "10" ],
		[ "482.185150", "2012", "08", "20", "07", "16", "09" ],
		[ "255.156647", "2012", "08", "20", "07", "15", "10" ],
		[ "270.608521", "2012", "08", "20", "07", "14", "10" ],
		[ "267.770142", "2012", "08", "20", "07", "13", "10" ],
		[ "237.509033", "2012", "08", "20", "07", "12", "09" ],
		[ "226.564758", "2012", "08", "20", "07", "11", "10" ],
		[ "226.486053", "2012", "08", "20", "07", "10", "10" ],
		[ "220.248123", "2012", "08", "20", "07", "09", "10" ],
		[ "225.376648", "2012", "08", "20", "07", "08", "10" ],
		[ "242.503677", "2012", "08", "20", "07", "07", "10" ],
		[ "241.015381", "2012", "08", "20", "07", "06", "10" ],
		[ "234.497711", "2012", "08", "20", "07", "05", "10" ],
		[ "223.612427", "2012", "08", "20", "07", "04", "09" ],
		[ "205.554688", "2012", "08", "20", "07", "03", "10" ],
		[ "212.791550", "2012", "08", "20", "07", "02", "10" ],
		[ "208.572754", "2012", "08", "20", "07", "01", "10" ],
		[ "207.728485", "2012", "08", "20", "07", "00", "10" ],
		[ "205.911499", "2012", "08", "20", "06", "59", "10" ],
		[ "203.808685", "2012", "08", "20", "06", "58", "10" ],
		[ "202.212585", "2012", "08", "20", "06", "57", "09" ],
		[ "201.668488", "2012", "08", "20", "06", "56", "09" ],
		[ "199.083435", "2012", "08", "20", "06", "55", "10" ],
		[ "197.054932", "2012", "08", "20", "06", "54", "09" ],
		[ "189.969650", "2012", "08", "20", "06", "53", "10" ],
		[ "191.689789", "2012", "08", "20", "06", "52", "10" ],
		[ "188.817505", "2012", "08", "20", "06", "51", "09" ],
		[ "188.423859", "2012", "08", "20", "06", "50", "10" ],
		[ "189.875229", "2012", "08", "20", "06", "49", "10" ],
		[ "189.193481", "2012", "08", "20", "06", "48", "10" ],
		[ "188.793549", "2012", "08", "20", "06", "47", "10" ],
		[ "186.915054", "2012", "08", "20", "06", "46", "09" ],
		[ "183.817841", "2012", "08", "20", "06", "45", "10" ],
		[ "186.592072", "2012", "08", "20", "06", "44", "10" ],
		[ "186.508698", "2012", "08", "20", "06", "43", "09" ],
		[ "189.466553", "2012", "08", "20", "06", "42", "09" ],
		[ "188.549957", "2012", "08", "20", "06", "41", "09" ],
		[ "188.487518", "2012", "08", "20", "06", "40", "10" ],
		[ "188.690735", "2012", "08", "20", "06", "39", "09" ],
		[ "186.445206", "2012", "08", "20", "06", "38", "10" ],
		[ "185.291107", "2012", "08", "20", "06", "37", "10" ],
		[ "184.888535", "2012", "08", "20", "06", "36", "10" ],
		[ "182.508926", "2012", "08", "20", "06", "35", "10" ],
		[ "182.132355", "2012", "08", "20", "06", "34", "09" ],
		[ "183.561066", "2012", "08", "20", "06", "33", "10" ],
		[ "181.214203", "2012", "08", "20", "06", "32", "10" ],
		[ "179.008148", "2012", "08", "20", "06", "31", "09" ],
		[ "176.810745", "2012", "08", "20", "06", "30", "10" ],
		[ "176.671204", "2012", "08", "20", "06", "29", "09" ],
		[ "179.381989", "2012", "08", "20", "06", "28", "10" ],
		[ "173.642487", "2012", "08", "20", "06", "27", "10" ],
		[ "175.787384", "2012", "08", "20", "06", "26", "10" ],
		[ "177.641388", "2012", "08", "20", "06", "25", "10" ],
		[ "178.052551", "2012", "08", "20", "06", "24", "10" ],
		[ "177.533905", "2012", "08", "20", "06", "23", "10" ],
		[ "180.975113", "2012", "08", "20", "06", "22", "10" ],
		[ "184.910583", "2012", "08", "20", "06", "21", "10" ],
		[ "182.498138", "2012", "08", "20", "06", "20", "10" ],
		[ "185.052765", "2012", "08", "20", "06", "19", "10" ],
		[ "187.053696", "2012", "08", "20", "06", "18", "10" ],
		[ "184.808258", "2012", "08", "20", "06", "17", "10" ],
		[ "184.177536", "2012", "08", "20", "06", "16", "10" ],
		[ "182.439392", "2012", "08", "20", "06", "15", "10" ],
		[ "184.019836", "2012", "08", "20", "06", "14", "10" ],
		[ "181.356598", "2012", "08", "20", "06", "13", "10" ],
		[ "175.973999", "2012", "08", "20", "06", "12", "10" ],
		[ "177.178802", "2012", "08", "20", "06", "11", "10" ],
		[ "177.097244", "2012", "08", "20", "06", "10", "10" ],
		[ "178.903305", "2012", "08", "20", "06", "09", "10" ],
		[ "177.912354", "2012", "08", "20", "06", "08", "10" ],
		[ "172.757629", "2012", "08", "20", "06", "07", "10" ],
		[ "161.787964", "2012", "08", "20", "06", "06", "10" ],
		[ "161.510574", "2012", "08", "20", "06", "05", "10" ],
		[ "162.320938", "2012", "08", "20", "06", "04", "10" ],
		[ "162.390411", "2012", "08", "20", "06", "03", "10" ],
		[ "161.696930", "2012", "08", "20", "06", "02", "10" ],
		[ "161.432098", "2012", "08", "20", "06", "01", "10" ],
		[ "161.535889", "2012", "08", "20", "06", "00", "10" ],
		[ "161.455963", "2012", "08", "20", "05", "59", "10" ],
		[ "161.589523", "2012", "08", "20", "05", "58", "10" ],
		[ "53.569881", "2012", "08", "20", "05", "57", "10" ],
		[ "1.504937", "2012", "08", "20", "05", "56", "10" ],
		[ "1.503692", "2012", "08", "20", "05", "55", "10" ],
		[ "1.526250", "2012", "08", "20", "05", "54", "10" ],
		[ "1.485068", "2012", "08", "20", "05", "53", "10" ],
		[ "1.500397", "2012", "08", "20", "05", "52", "10" ],
		[ "1.530911", "2012", "08", "20", "05", "51", "10" ],
		[ "1.503991", "2012", "08", "20", "05", "50", "10" ],
		[ "1.541698", "2012", "08", "20", "05", "49", "10" ],
		[ "1.508619", "2012", "08", "20", "05", "48", "10" ],
		[ "1.535379", "2012", "08", "20", "05", "47", "10" ],
		[ "1.525790", "2012", "08", "20", "05", "46", "10" ],
		[ "1.506531", "2012", "08", "20", "05", "45", "10" ],
		[ "1.556811", "2012", "08", "20", "05", "44", "10" ],
		[ "1.541288", "2012", "08", "20", "05", "43", "10" ],
		[ "1.496658", "2012", "08", "20", "05", "42", "10" ],
		[ "1.504644", "2012", "08", "20", "05", "41", "10" ],
		[ "1.499517", "2012", "08", "20", "05", "40", "10" ],
		[ "1.528233", "2012", "08", "20", "05", "39", "10" ],
		[ "1.520514", "2012", "08", "20", "05", "38", "10" ],
		[ "1.526900", "2012", "08", "20", "05", "37", "10" ],
		[ "1.485985", "2012", "08", "20", "05", "36", "10" ],
		[ "1.533152", "2012", "08", "20", "05", "35", "10" ],
		[ "1.494511", "2012", "08", "20", "05", "34", "10" ],
		[ "1.441485", "2012", "08", "20", "05", "33", "10" ],
		[ "1.461875", "2012", "08", "20", "05", "32", "10" ],
		[ "1.500201", "2012", "08", "20", "05", "31", "10" ] ];